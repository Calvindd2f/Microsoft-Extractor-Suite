name: Build and Release

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Check for Trailing Whitespace
        run: |
          echo "Checking for trailing whitespace..."
          if grep -r '[[:space:]]$' --include="*.cs" src/; then
            echo "‚ùå Trailing whitespace found in the following files:"
            grep -r '[[:space:]]$' --include="*.cs" src/ -l
            echo ""
            echo "Please remove trailing whitespace before committing."
            exit 1
          else
            echo "‚úÖ No trailing whitespace found"
          fi

      - name: Format Check
        run: |
          dotnet format src/Microsoft.ExtractorSuite.csproj --verify-no-changes --verbosity diagnostic || true

  build:
    name: Build Module
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        configuration: [Release, Debug]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet Packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Microsoft.ExtractorSuite.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore Dependencies
        run: dotnet restore src/Microsoft.ExtractorSuite.csproj

      - name: Build Module
        run: |
          dotnet build src/Microsoft.ExtractorSuite.csproj \
            --configuration ${{ matrix.configuration }} \
            --no-restore \
            /p:TreatWarningsAsErrors=false \
            /p:WarningLevel=1 \
            /p:NoWarn="CS8600;CS8601;CS8602;CS8603;CS8604;CS8618;CS8625;CS8425;CS1591"

      - name: Upload Build Artifacts
        if: matrix.os == 'windows-latest' && matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: |
            src/bin/${{ matrix.configuration }}/netstandard2.0/
            Microsoft-Extractor-Suite.psd1
            Microsoft-Extractor-Suite.psm1
            Scripts/
            Templates/

  test:
    name: Test Module
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PowerShell
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Install PowerShell on Ubuntu
          wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-windows-latest
          path: ./Output

      - name: Run PowerShell Tests
        shell: pwsh
        run: |
          # Import module
          Import-Module ./Microsoft-Extractor-Suite.psd1 -Force
          
          # Get available commands
          $commands = Get-Command -Module Microsoft-Extractor-Suite
          Write-Host "Found $($commands.Count) commands in the module"
          
          # Verify core commands exist
          $coreCommands = @(
            'Connect-M365',
            'Disconnect-M365',
            'Get-UAL',
            'Get-AdminAuditLog',
            'Get-MailboxAuditLog',
            'Get-MessageTraceLog',
            'Get-UsersInfo',
            'Get-Groups',
            'Get-Roles'
          )
          
          $missingCommands = @()
          foreach ($cmd in $coreCommands) {
            if (-not (Get-Command -Name $cmd -Module Microsoft-Extractor-Suite -ErrorAction SilentlyContinue)) {
              $missingCommands += $cmd
            }
          }
          
          if ($missingCommands.Count -gt 0) {
            Write-Error "Missing core commands: $($missingCommands -join ', ')"
            exit 1
          }
          
          Write-Host "‚úÖ All core commands are available"

  package:
    name: Package Module
    runs-on: windows-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name PowerShellGet -Force -AllowClobber

      - name: Build Release Package
        shell: pwsh
        run: |
          # Run build script
          ./Build-Module.ps1 -Configuration Release -Clean
          
          # Create output directory
          $outputPath = Join-Path $PWD "Release"
          New-Item -ItemType Directory -Path $outputPath -Force | Out-Null
          
          # Package module
          $moduleName = "Microsoft-Extractor-Suite"
          $version = (Import-PowerShellDataFile -Path "./Microsoft-Extractor-Suite.psd1").ModuleVersion
          $packageName = "$moduleName-v$version"
          
          # Create module directory structure
          $moduleDir = Join-Path $outputPath $packageName
          New-Item -ItemType Directory -Path $moduleDir -Force | Out-Null
          
          # Copy module files
          Copy-Item -Path "./Microsoft-Extractor-Suite.psd1" -Destination $moduleDir
          Copy-Item -Path "./Microsoft-Extractor-Suite.psm1" -Destination $moduleDir
          Copy-Item -Path "./Scripts" -Destination $moduleDir -Recurse
          Copy-Item -Path "./Templates" -Destination $moduleDir -Recurse
          Copy-Item -Path "./README.md" -Destination $moduleDir
          Copy-Item -Path "./LICENSE" -Destination $moduleDir
          
          # Copy built binaries
          $binPath = Join-Path $moduleDir "bin"
          New-Item -ItemType Directory -Path $binPath -Force | Out-Null
          Copy-Item -Path "src/bin/Release/netstandard2.0/*" -Destination $binPath -Recurse
          
          # Create ZIP archive
          Compress-Archive -Path $moduleDir -DestinationPath "$outputPath/$packageName.zip" -Force
          
          Write-Host "‚úÖ Package created: $packageName.zip"

      - name: Upload Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: module-package
          path: Release/*.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Package
        uses: actions/download-artifact@v4
        with:
          name: module-package
          path: ./Release

      - name: Extract Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +'%Y.%m.%d')-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Generate Release Notes
        id: notes
        run: |
          cat << EOF > release-notes.md
          ## Microsoft Extractor Suite ${{ steps.version.outputs.version }}
          
          ### üöÄ What's New
          - Enhanced C# cmdlet implementations
          - Improved error handling and logging
          - Better Graph API integration
          - Performance optimizations
          
          ### üì¶ Installation
          
          1. Download the package below
          2. Extract the ZIP file
          3. Import the module:
             \`\`\`powershell
             Import-Module ./Microsoft-Extractor-Suite/Microsoft-Extractor-Suite.psd1
             \`\`\`
          
          ### üîß Requirements
          - PowerShell 5.1 or later
          - .NET Standard 2.0 compatible runtime
          - Microsoft 365 tenant with appropriate permissions
          
          ### üìù Changes
          $(git log -10 --pretty=format:"- %s" --no-merges)
          
          ### üôè Contributors
          Thank you to all contributors who made this release possible!
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Microsoft Extractor Suite ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'dev') }}
          files: |
            Release/*.zip

  publish-psgallery:
    name: Publish to PowerShell Gallery
    runs-on: windows-latest
    needs: release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'beta') && !contains(github.ref, 'alpha')
    environment: production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name PowerShellGet -Force -AllowClobber

      - name: Build Module
        shell: pwsh
        run: ./Build-Module.ps1 -Configuration Release

      - name: Publish to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if ($env:PSGALLERY_API_KEY) {
            Publish-Module -Path ./Output/Microsoft-Extractor-Suite -NuGetApiKey $env:PSGALLERY_API_KEY -Repository PSGallery
            Write-Host "‚úÖ Module published to PowerShell Gallery"
          } else {
            Write-Warning "PSGallery API key not configured - skipping publish"
          }